# Data Flow Diagrams - Handheld Firebase Upload

## 1. Complete BLE to Firebase Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    HANDHELD DEVICE (ESP32-S3)                      â”‚
â”‚                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ App State: SENSOR_DATA_TRANSFER                              â”‚ â”‚
â”‚  â”‚                                                              â”‚ â”‚
â”‚  â”‚ 1. Read soil sensor                                         â”‚ â”‚
â”‚  â”‚ 2. Format JSON: {temp, moisture, ec, ph, n, p, k}          â”‚ â”‚
â”‚  â”‚ 3. Wait for Mobile App subscription                         â”‚ â”‚
â”‚  â”‚ 4. Send notification with sensor data                       â”‚ â”‚
â”‚  â”‚ 5. Disconnect from BLE â†’ Reboot                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                            â”‚                                       â”‚
â”‚                            â”‚ BLE Notification                      â”‚
â”‚                            â”‚ UUID: ffe1                            â”‚
â”‚                            â”‚ Data: JSON                            â”‚
â”‚                            â–¼                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MOBILE APP (Flutter)                            â”‚
â”‚          handheld_sensor_data_screen.dart                          â”‚
â”‚                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Step 1: BLE Connection & Discovery                          â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚ Status: "Káº¿t ná»‘i Ä‘áº¿n Handheld..."                          â”‚  â”‚
â”‚  â”‚ Status: "TÃ¬m kiáº¿m BLE services..."                         â”‚  â”‚
â”‚  â”‚ Status: "Chá» dá»¯ liá»‡u cáº£m biáº¿n..."                          â”‚  â”‚
â”‚  â”‚ (Spinner: ğŸ”„)                                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                       â”‚                                            â”‚
â”‚                       â–¼                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Step 2: Data Reception (Async)                              â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚ subscription.onValueReceived.listen((value) async {         â”‚  â”‚
â”‚  â”‚   1. Decode value as UTF-8                                 â”‚  â”‚
â”‚  â”‚   2. Parse JSON                                            â”‚  â”‚
â”‚  â”‚   3. Set _sensorData = data                                â”‚  â”‚
â”‚  â”‚   4. Set _isUploading = true                               â”‚  â”‚
â”‚  â”‚   5. Call _uploadToFirebase(data)  â† NEW                   â”‚  â”‚
â”‚  â”‚ })                                                          â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚ Status: "ÄÃ£ nháº­n dá»¯ liá»‡u cáº£m biáº¿n!"                        â”‚  â”‚
â”‚  â”‚ Display: Sensor readings (temp, moisture, ec, ph, npk)    â”‚  â”‚
â”‚  â”‚ (Spinner: ğŸ”„)                                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                       â”‚                                            â”‚
â”‚                       â–¼                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Step 3: Firebase Upload (NEW)                               â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚ _uploadToFirebase(Map<String, dynamic> sensorData)          â”‚  â”‚
â”‚  â”‚ {                                                           â”‚  â”‚
â”‚  â”‚   setState(() => _statusMessage = 'Äang táº£i...')           â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚   final success = await firebaseService                    â”‚  â”‚
â”‚  â”‚       .addHandheldSensorData(sensorData)                   â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚   setState(() {                                            â”‚  â”‚
â”‚  â”‚     _isUploading = false                                   â”‚  â”‚
â”‚  â”‚     if (success) {                                         â”‚  â”‚
â”‚  â”‚       _statusMessage = 'âœ… Dá»¯ liá»‡u Ä‘Ã£ lÆ°u...'              â”‚  â”‚
â”‚  â”‚     } else {                                               â”‚  â”‚
â”‚  â”‚       _statusMessage = 'âš ï¸ Lá»—i táº£i lÃªn...'                 â”‚  â”‚
â”‚  â”‚     }                                                      â”‚  â”‚
â”‚  â”‚   })                                                       â”‚  â”‚
â”‚  â”‚ }                                                           â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚ Status: "Äang táº£i lÃªn Firebase..."                         â”‚  â”‚
â”‚  â”‚ (Spinner: ğŸ”„)                                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                       â”‚                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ Firebase Write Request
                        â”‚ Path: sensor_data/{userUID}/handheld/{timestamp}
                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       â–¼                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ FirebaseService.addHandheldSensorData()                      â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚ 1. Get current userUID from AuthService                     â”‚  â”‚
â”‚  â”‚ 2. Check if user is logged in                              â”‚  â”‚
â”‚  â”‚ 3. Create timestamp: DateTime.now() / 1000                 â”‚  â”‚
â”‚  â”‚ 4. Prepare data:                                           â”‚  â”‚
â”‚  â”‚    - Copy input data                                       â”‚  â”‚
â”‚  â”‚    - Add timestamp                                         â”‚  â”‚
â”‚  â”‚    - Add deviceType: "soil_sensor"                         â”‚  â”‚
â”‚  â”‚    - Add nodeId: "handheld"                                â”‚  â”‚
â”‚  â”‚ 5. Write to Firebase:                                      â”‚  â”‚
â”‚  â”‚    database.ref('sensor_data/$userUID/handheld/$timestamp')â”‚  â”‚
â”‚  â”‚    .set(data)                                              â”‚  â”‚
â”‚  â”‚ 6. Return true on success                                  â”‚  â”‚
â”‚  â”‚ 7. Return false on error                                   â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚ Error Handling:                                            â”‚  â”‚
â”‚  â”‚ - User not logged in â†’ return false                        â”‚  â”‚
â”‚  â”‚ - Firebase error â†’ catch & log, return false               â”‚  â”‚
â”‚  â”‚ - Network error â†’ catch & log, return false                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                       â”‚                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ Database Write
                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       â–¼                                            â”‚
â”‚        FIREBASE REALTIME DATABASE                                 â”‚
â”‚                                                                    â”‚
â”‚  sensor_data/                                                      â”‚
â”‚  â””â”€â”€ {userUID}/                                                   â”‚
â”‚      â””â”€â”€ handheld/                                                â”‚
â”‚          â””â”€â”€ 1732689600/  â† timestamp                             â”‚
â”‚              â”œâ”€â”€ timestamp: 1732689600                            â”‚
â”‚              â”œâ”€â”€ deviceType: "soil_sensor"                        â”‚
â”‚              â”œâ”€â”€ nodeId: "handheld"                               â”‚
â”‚              â”œâ”€â”€ temp: 28.5                                       â”‚
â”‚              â”œâ”€â”€ temperature: 28.5                                â”‚
â”‚              â”œâ”€â”€ moisture: 65.3                                   â”‚
â”‚              â”œâ”€â”€ ec: 2.1                                          â”‚
â”‚              â”œâ”€â”€ ph: 7.2                                          â”‚
â”‚              â”œâ”€â”€ n: 145                                           â”‚
â”‚              â”œâ”€â”€ p: 98                                            â”‚
â”‚              â””â”€â”€ k: 210                                           â”‚
â”‚                                                                    â”‚
â”‚          â””â”€â”€ 1732689700/  â† next reading                          â”‚
â”‚              â””â”€â”€ (same structure with different values)           â”‚
â”‚                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 2. State Diagram - Mobile App Status Flow

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Báº¯t Ä‘áº§u...      â”‚
                    â”‚ (Starting)      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Káº¿t ná»‘i Ä‘áº¿n Handheld...        â”‚
            â”‚ (Connecting to Handheld)       â”‚
            â”‚ Status: ğŸ”„ Connecting         â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ TÃ¬m kiáº¿m BLE services...       â”‚
            â”‚ (Discovering Services)         â”‚
            â”‚ Status: ğŸ”„ Discovering        â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Chá» dá»¯ liá»‡u cáº£m biáº¿n...        â”‚
            â”‚ (Waiting for Sensor Data)      â”‚
            â”‚ Status: ğŸ”„ Waiting            â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
                    â”‚ Received? â”‚
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ Yes
                         â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ ÄÃ£ nháº­n dá»¯ liá»‡u cáº£m biáº¿n!      â”‚
            â”‚ (Data Received)                â”‚
            â”‚ Status: ğŸ”„ Uploading          â”‚ â† _isUploading = true
            â”‚ Display: Sensor readings      â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Äang táº£i lÃªn Firebase...       â”‚
            â”‚ (Uploading to Firebase)        â”‚
            â”‚ Status: ğŸ”„ Uploading          â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Upload Status â”‚
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”˜
                    YES  â”‚          â”‚  NO
                    â”Œâ”€â”€â”€â”€â–¼â”€â”    â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”
                    â”‚âœ…    â”‚    â”‚âš ï¸      â”‚
                    â””â”€â”€â”€â”€â”¬â”€â”˜    â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                         â”‚         â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ âœ… Dá»¯ liá»‡u Ä‘Ã£ â”‚  â”‚ âš ï¸ Lá»—i táº£i lÃªn â”‚
            â”‚ lÆ°u lÃªn       â”‚  â”‚ Firebase       â”‚
            â”‚ Firebase!     â”‚  â”‚                â”‚
            â”‚ Status: ğŸŸ¢    â”‚  â”‚ Status: ğŸ”´    â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 3. Class Diagram - Firebase Service

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       FirebaseService (Singleton)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Properties:                                         â”‚
â”‚ - _database: FirebaseDatabase                       â”‚
â”‚ - _currentUserUID: String?                          â”‚
â”‚ - sensorDataPath: "sensor_data"                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Methods:                                            â”‚
â”‚ + getNodesStream(): Stream<List<Device>>           â”‚
â”‚ + getSensorDataStream(): Stream<List<SensorData>>  â”‚
â”‚ + getLatestSensorData(): Future<SensorData?>       â”‚
â”‚ + addSensorData(): Future<void>                    â”‚
â”‚ + addHandheldSensorData(): Future<bool>  â† NEW     â”‚
â”‚ + registerGateway(): Future<void>                  â”‚
â”‚ + cleanupOldData(): Future<void>                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ NEW METHOD:                                         â”‚
â”‚ + addHandheldSensorData(                           â”‚
â”‚     Map<String, dynamic> sensorDataJson            â”‚
â”‚   ): Future<bool>                                  â”‚
â”‚                                                     â”‚
â”‚   Implementation:                                  â”‚
â”‚   1. Get current user UID                          â”‚
â”‚   2. If null, throw "User not logged in"          â”‚
â”‚   3. Get current timestamp                         â”‚
â”‚   4. Prepare data with metadata                    â”‚
â”‚   5. Write to database                             â”‚
â”‚   6. Return true/false                             â”‚
â”‚                                                     â”‚
â”‚   Error Handling:                                  â”‚
â”‚   - Auth check                                     â”‚
â”‚   - Exception catch & log                          â”‚
â”‚   - Return false on error                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 4. Sequence Diagram - Complete Upload Flow

```
Mobile App              Handheld          Firebase
    â”‚                      â”‚                  â”‚
    â”œâ”€â”€â”€ Scan BLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚
    â”‚                      â”‚                  â”‚
    â”œâ”€â”€â”€â”€â”€â”€ Connect â”€â”€â”€â”€â”€â”€â–ºâ”‚                  â”‚
    â”‚                      â”‚                  â”‚
    â”œâ”€ Discover Services â”€â”€â”¤                  â”‚
    â”‚                      â”‚                  â”‚
    â”œâ”€ Subscribe to Data â”€â”€â”¤                  â”‚
    â”‚                      â”‚                  â”‚
    â”‚                      â”‚â”€ Notify (JSON) â”€â”¤
    â”‚â—„â”€â”€â”€â”€â”€â”€â”€ Data â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚
    â”‚                      â”‚                  â”‚
    â”œâ”€ Parse JSON          â”‚                  â”‚
    â”‚                      â”‚                  â”‚
    â”œâ”€ Prepare Upload â”€â”€â”€â”€â”€â”¤                  â”‚
    â”‚                      â”‚                  â”‚
    â”œâ”€ Set Auth & Data â”€â”€â”€â”€â”¤                  â”‚
    â”‚                      â”‚                  â”‚
    â”œâ”€ Firebase Write â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚                  â”‚
    â”‚                      â”‚          âœ… Stored
    â”‚â—„â”€ Write Response â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                      â”‚                  â”‚
    â”œâ”€ Update UI (âœ…)       â”‚                  â”‚
    â”‚                      â”‚                  â”‚
    â”œâ”€ Unsubscribe â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚
    â”‚                      â”‚                  â”‚
    â”œâ”€ Disconnect â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚
    â”‚                      â”‚                  â”‚
    â”‚                      â”‚â”€â”€â”€ Disconnect â”€â”€â”¤
    â”‚                      â”‚                  â”‚
    â”‚                      â”‚â”€â”€ Reboot â”€â”€     â”‚
    â”‚                      â”‚                  â”‚

Timing:
- BLE Connection: ~2-3s
- Data Reception: < 1s
- Firebase Upload: < 2s
- Total: ~5s
```

## 5. Data Structure Hierarchy

```
Firebase Realtime Database
â”‚
â””â”€â”€ sensor_data/                          â† Historical data
    â”‚
    â””â”€â”€ {userUID}/                        â† User partition
        â”‚
        â”œâ”€â”€ handheld/                     â† Handheld device data
        â”‚   â”‚
        â”‚   â”œâ”€â”€ 1732689600/               â† Timestamp 1
        â”‚   â”‚   â”œâ”€â”€ timestamp: 1732689600
        â”‚   â”‚   â”œâ”€â”€ deviceType: "soil_sensor"
        â”‚   â”‚   â”œâ”€â”€ nodeId: "handheld"
        â”‚   â”‚   â”œâ”€â”€ temp: 28.5
        â”‚   â”‚   â”œâ”€â”€ temperature: 28.5
        â”‚   â”‚   â”œâ”€â”€ moisture: 65.3
        â”‚   â”‚   â”œâ”€â”€ ec: 2.1
        â”‚   â”‚   â”œâ”€â”€ ph: 7.2
        â”‚   â”‚   â”œâ”€â”€ n: 145
        â”‚   â”‚   â”œâ”€â”€ p: 98
        â”‚   â”‚   â””â”€â”€ k: 210
        â”‚   â”‚
        â”‚   â””â”€â”€ 1732689700/               â† Timestamp 2
        â”‚       â””â”€â”€ (same structure)
        â”‚
        â”œâ”€â”€ 0xABCD/                       â† Gateway sensor node
        â”‚   â”œâ”€â”€ 1732689600/
        â”‚   â”‚   â””â”€â”€ (sensor data)
        â”‚   â””â”€â”€ 1732689700/
        â”‚       â””â”€â”€ (sensor data)
        â”‚
        â””â”€â”€ 0xDEF0/                       â† Another sensor node
            â””â”€â”€ (similar structure)

Query Pattern:
To get all handheld readings:
  sensor_data/{userUID}/handheld

To get specific reading:
  sensor_data/{userUID}/handheld/{timestamp}

To get latest reading:
  sensor_data/{userUID}/handheld
  â†’ orderByKey()
  â†’ limitToLast(1)
```

## 6. Error Handling Flow

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Upload Data      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ User Logged In?  â”‚
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”˜
                         â”‚No       â”‚Yes
                    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”  â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Return â”‚  â”‚ Get timestamp  â”‚
                    â”‚ false  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
                                         â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ Prepare data     â”‚
                              â”‚ - Copy fields    â”‚
                              â”‚ - Add metadata   â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ Firebase write   â”‚
                              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”˜
                                   â”‚Success  â”‚Error
                              â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”  â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ Log âœ… â”‚  â”‚ Catch err  â”‚
                              â”‚ Return â”‚  â”‚ Log âŒ     â”‚
                              â”‚ true   â”‚  â”‚ Return     â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ false      â”‚
                                         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                                                 â”‚
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚ UI shows error   â”‚
                         â”‚ "âš ï¸ Lá»—i táº£i..."   â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Summary

The implementation creates a seamless flow:
1. **BLE Reception** - Get JSON data from Handheld
2. **Parsing** - Decode and validate JSON
3. **Upload** - Send to Firebase with user context
4. **Feedback** - Show status to user
5. **Error Handling** - Graceful failures without crashes

This ensures all handheld sensor readings are automatically saved to Firebase for historical tracking and analysis.
